# MDB-Flow Agent Architecture

## System Overview

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                         Streamlit UI                             â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”          â”‚
â”‚  â”‚ Text Input   â”‚  â”‚ Voice Input  â”‚  â”‚ Slash Cmds   â”‚          â”‚
â”‚  â”‚ "Create..."  â”‚  â”‚ ğŸ¤ "Mark..." â”‚  â”‚ /tasks       â”‚          â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜          â”‚
â”‚         â”‚                  â”‚                  â”‚                   â”‚
â”‚         â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                  â”‚
â”‚                            â”‚                                      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                             â–¼
              â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
              â”‚    Route Decision            â”‚
              â”‚  Slash? â†’ Direct DB          â”‚
              â”‚  Text/Voice? â†’ Coordinator   â”‚
              â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                             â”‚
          â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
          â–¼                                     â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”              â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Slash Commands     â”‚              â”‚  Coordinator Agent   â”‚
â”‚  (Direct DB Query)  â”‚              â”‚  (LLM + Routing)     â”‚
â”‚                     â”‚              â”‚                      â”‚
â”‚  â€¢ /tasks           â”‚              â”‚  â€¢ 21 tools exposed  â”‚
â”‚  â€¢ /projects        â”‚              â”‚  â€¢ 1 LLM instance    â”‚
â”‚  â€¢ /do              â”‚              â”‚  â€¢ Routes to agents  â”‚
â”‚  â€¢ /search          â”‚              â”‚                      â”‚
â”‚                     â”‚              â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
â”‚  â±ï¸ 50-150ms        â”‚                         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                         â”‚
           â”‚                                    â”‚
           â”‚                      â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
           â”‚                      â–¼                           â–¼
           â”‚           â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”      â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
           â”‚           â”‚ Retrieval Agent  â”‚      â”‚  Worklog Agent   â”‚
           â”‚           â”‚  (READ ops)      â”‚      â”‚  (WRITE ops)     â”‚
           â”‚           â”‚                  â”‚      â”‚                  â”‚
           â”‚           â”‚  â€¢ Search tasks  â”‚      â”‚  â€¢ Create task   â”‚
           â”‚           â”‚  â€¢ Search proj   â”‚      â”‚  â€¢ Update task   â”‚
           â”‚           â”‚  â€¢ Get by time   â”‚      â”‚  â€¢ Complete task â”‚
           â”‚           â”‚                  â”‚      â”‚  â€¢ Add notes     â”‚
           â”‚           â”‚  Has LLM âŒ      â”‚      â”‚                  â”‚
           â”‚           â”‚  (not used)      â”‚      â”‚  Has LLM âŒ      â”‚
           â”‚           â”‚                  â”‚      â”‚  (not used)      â”‚
           â”‚           â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜      â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
           â”‚                    â”‚                         â”‚
           â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                â”‚
                                â–¼
                    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                    â”‚   MongoDB Database    â”‚
                    â”‚                       â”‚
                    â”‚  â€¢ tasks collection   â”‚
                    â”‚  â€¢ projects collectionâ”‚
                    â”‚                       â”‚
                    â”‚  â±ï¸ 50-150ms/query    â”‚
                    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

## Agent Responsibilities

| Agent | Has LLM? | LLM Used? | Role | Methods |
|-------|----------|-----------|------|---------|
| **Coordinator** | âœ… Yes | âœ… YES | Decision maker, router | process(), _execute_tool() |
| **Worklog** | âœ… Yes | âŒ No | Database writes | _create_task(), _update_task(), _complete_task(), etc. |
| **Retrieval** | âœ… Yes | âŒ No | Database reads, search | hybrid_search_tasks(), get_tasks_by_activity() |

**Key Insight:** Only the Coordinator's LLM is used. Worklog and Retrieval are "dumb executors" - they just perform DB operations when called.

---

## Flow 1: "Create a task for debugging in AgentOps"

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ USER INPUT                                                          â”‚
â”‚ "Create a task for debugging in AgentOps"                          â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                            â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ STEP 1: Streamlit receives input                                   â”‚
â”‚                                                                     â”‚
â”‚  streamlit_app.py:                                                 â”‚
â”‚  - Checks if slash command? No                                     â”‚
â”‚  - Adds to conversation history                                    â”‚
â”‚  - Calls: coordinator.process(prompt, history)                     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                            â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ STEP 2: Coordinator prepares LLM call                              â”‚
â”‚                                                                     â”‚
â”‚  coordinator.py:900-920:                                           â”‚
â”‚  messages = [                                                      â”‚
â”‚    {"role": "user", "content": "What tasks do I have?"},           â”‚
â”‚    {"role": "assistant", "content": [...]},                        â”‚
â”‚    {"role": "user", "content": "Create a task for debugging..."}   â”‚
â”‚  ]                                                                 â”‚
â”‚                                                                     â”‚
â”‚  tools = COORDINATOR_TOOLS  # 21 tools                             â”‚
â”‚  system = SYSTEM_PROMPT     # "Always use tools..."                â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                            â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ STEP 3: LLM decides action                                         â”‚
â”‚                                                                     â”‚
â”‚  ğŸ”µ Claude API Call (~2-3 seconds)                                 â”‚
â”‚                                                                     â”‚
â”‚  Input: messages + 21 tools + system prompt                        â”‚
â”‚  Output:                                                           â”‚
â”‚  {                                                                 â”‚
â”‚    "stop_reason": "tool_use",                                      â”‚
â”‚    "content": [{                                                   â”‚
â”‚      "type": "tool_use",                                           â”‚
â”‚      "name": "create_task",                                        â”‚
â”‚      "input": {                                                    â”‚
â”‚        "title": "Debugging",                                       â”‚
â”‚        "project_name": "AgentOps",                                 â”‚
â”‚        "priority": "medium"                                        â”‚
â”‚      }                                                             â”‚
â”‚    }]                                                              â”‚
â”‚  }                                                                 â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                            â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ STEP 4: Coordinator routes tool call                               â”‚
â”‚                                                                     â”‚
â”‚  coordinator._execute_tool("create_task", {...})                   â”‚
â”‚                                                                     â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚ Sub-step 4a: Look up project by name                         â”‚ â”‚
â”‚  â”‚                                                               â”‚ â”‚
â”‚  â”‚ projects = retrieval_agent.hybrid_search_projects(           â”‚ â”‚
â”‚  â”‚   "AgentOps", limit=1                                        â”‚ â”‚
â”‚  â”‚ )                                                             â”‚ â”‚
â”‚  â”‚                                                               â”‚ â”‚
â”‚  â”‚ ğŸŸ¢ MongoDB Query (~100ms)                                     â”‚ â”‚
â”‚  â”‚ - Vector search on embeddings                                â”‚ â”‚
â”‚  â”‚ - Text search on name                                        â”‚ â”‚
â”‚  â”‚ - Returns: [{"_id": "6959d9...", "name": "AgentOps"}]        â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â”‚                                                                     â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚ Sub-step 4b: Create task                                      â”‚ â”‚
â”‚  â”‚                                                               â”‚ â”‚
â”‚  â”‚ result = worklog_agent._create_task(                         â”‚ â”‚
â”‚  â”‚   title="Debugging",                                         â”‚ â”‚
â”‚  â”‚   project_id="6959d9...",                                    â”‚ â”‚
â”‚  â”‚   priority="medium"                                          â”‚ â”‚
â”‚  â”‚ )                                                             â”‚ â”‚
â”‚  â”‚                                                               â”‚ â”‚
â”‚  â”‚ ğŸŸ¡ Embedding API (~300ms)                                     â”‚ â”‚
â”‚  â”‚ - Generate vector for "Debugging"                            â”‚ â”‚
â”‚  â”‚                                                               â”‚ â”‚
â”‚  â”‚ ğŸ’¾ MongoDB Insert (~50ms)                                     â”‚ â”‚
â”‚  â”‚ - Insert task document                                       â”‚ â”‚
â”‚  â”‚                                                               â”‚ â”‚
â”‚  â”‚ Returns: {                                                    â”‚ â”‚
â”‚  â”‚   "success": true,                                           â”‚ â”‚
â”‚  â”‚   "task_id": "abc123...",                                    â”‚ â”‚
â”‚  â”‚   "task": {...}                                              â”‚ â”‚
â”‚  â”‚ }                                                             â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                            â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ STEP 5: Return to LLM for formatting                               â”‚
â”‚                                                                     â”‚
â”‚  Add to messages:                                                  â”‚
â”‚  - assistant message (tool_use)                                    â”‚
â”‚  - user message (tool_result)                                      â”‚
â”‚                                                                     â”‚
â”‚  ğŸ”µ Claude API Call #2 (~2 seconds)                                â”‚
â”‚                                                                     â”‚
â”‚  LLM formats response:                                             â”‚
â”‚  "âœ“ Created task **Debugging** in AgentOps (Medium priority)"      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                            â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ STEP 6: Display to user                                            â”‚
â”‚                                                                     â”‚
â”‚  Streamlit renders:                                                â”‚
â”‚  "âœ“ Created task **Debugging** in AgentOps (Medium priority)"      â”‚
â”‚                                                                     â”‚
â”‚  Debug Panel shows:                                                â”‚
â”‚  Turn 3 (ğŸ¤– LLM): "Create a task..." (4350ms)                      â”‚
â”‚    ğŸ”µ LLM: 4000ms (92%)                                            â”‚
â”‚    ğŸ› ï¸ Tools: 350ms (8%)                                            â”‚
â”‚      - Call 1: create_task (350ms)                                 â”‚
â”‚        â€¢ MongoDB: 100ms                                            â”‚
â”‚        â€¢ Embedding: 300ms                                          â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

â±ï¸ Total Time: ~4-5 seconds
   - LLM thinking: 4000ms (80%)
   - Project lookup: 100ms (2%)
   - Embedding generation: 300ms (6%)
   - MongoDB insert: 50ms (1%)
```

---

## Flow 2: "Mark task as in-progress"

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ USER INPUT                                                          â”‚
â”‚ "Mark debugging task as in-progress"                               â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                            â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ STEP 1: Coordinator + LLM                                          â”‚
â”‚                                                                     â”‚
â”‚  ğŸ”µ LLM Call #1: Decide action                                     â”‚
â”‚                                                                     â”‚
â”‚  LLM Output:                                                       â”‚
â”‚  {                                                                 â”‚
â”‚    "stop_reason": "tool_use",                                      â”‚
â”‚    "content": [{                                                   â”‚
â”‚      "type": "tool_use",                                           â”‚
â”‚      "name": "search_tasks",  â† MUST search first (system prompt) â”‚
â”‚      "input": {                                                    â”‚
â”‚        "query": "debugging task",                                  â”‚
â”‚        "limit": 5                                                  â”‚
â”‚      }                                                             â”‚
â”‚    }]                                                              â”‚
â”‚  }                                                                 â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                            â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ STEP 2: Search for task                                            â”‚
â”‚                                                                     â”‚
â”‚  coordinator._execute_tool("search_tasks", {...})                  â”‚
â”‚                                                                     â”‚
â”‚  tasks = retrieval_agent.hybrid_search_tasks(                      â”‚
â”‚    "debugging task", limit=5                                       â”‚
â”‚  )                                                                 â”‚
â”‚                                                                     â”‚
â”‚  ğŸŸ¢ MongoDB Hybrid Search (~150ms)                                 â”‚
â”‚  - Vector similarity on embeddings                                â”‚
â”‚  - Text search on title/context                                   â”‚
â”‚  - Combines and ranks results                                     â”‚
â”‚                                                                     â”‚
â”‚  Returns: [                                                        â”‚
â”‚    {                                                               â”‚
â”‚      "_id": "abc123",                                              â”‚
â”‚      "title": "Debugging",                                         â”‚
â”‚      "status": "todo",                                             â”‚
â”‚      "project_name": "AgentOps",                                   â”‚
â”‚      "score": 0.95                                                 â”‚
â”‚    },                                                              â”‚
â”‚    {...} // other matches                                         â”‚
â”‚  ]                                                                 â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                            â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ STEP 3: LLM asks for confirmation                                  â”‚
â”‚                                                                     â”‚
â”‚  ğŸ”µ LLM Call #2: Format response                                   â”‚
â”‚                                                                     â”‚
â”‚  LLM sees tool result and generates:                               â”‚
â”‚  "I found 1 task matching 'debugging task':                        â”‚
â”‚   1. **Debugging** (Todo) - AgentOps                               â”‚
â”‚                                                                     â”‚
â”‚   Is this the task you want to start? Please confirm."             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                            â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ USER RESPONDS                                                       â”‚
â”‚ "Yes"                                                               â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                            â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ STEP 4: Execute action                                             â”‚
â”‚                                                                     â”‚
â”‚  ğŸ”µ LLM Call #3: Decide action                                     â”‚
â”‚                                                                     â”‚
â”‚  LLM Output:                                                       â”‚
â”‚  {                                                                 â”‚
â”‚    "stop_reason": "tool_use",                                      â”‚
â”‚    "content": [{                                                   â”‚
â”‚      "type": "tool_use",                                           â”‚
â”‚      "name": "start_task",                                         â”‚
â”‚      "input": {                                                    â”‚
â”‚        "task_id": "abc123"  â† From previous search results        â”‚
â”‚      }                                                             â”‚
â”‚    }]                                                              â”‚
â”‚  }                                                                 â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                            â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ STEP 5: Update task status                                         â”‚
â”‚                                                                     â”‚
â”‚  coordinator._execute_tool("start_task", {"task_id": "abc123"})    â”‚
â”‚                                                                     â”‚
â”‚  result = worklog_agent._update_task(                              â”‚
â”‚    "abc123",                                                       â”‚
â”‚    status="in_progress"                                            â”‚
â”‚  )                                                                 â”‚
â”‚                                                                     â”‚
â”‚  ğŸ’¾ MongoDB Update (~50ms)                                         â”‚
â”‚  db.tasks.update_one(                                              â”‚
â”‚    {"_id": "abc123"},                                              â”‚
â”‚    {"$set": {"status": "in_progress"}}                             â”‚
â”‚  )                                                                 â”‚
â”‚                                                                     â”‚
â”‚  Returns: {                                                        â”‚
â”‚    "success": true,                                                â”‚
â”‚    "task": {...}                                                   â”‚
â”‚  }                                                                 â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                            â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ STEP 6: Confirm to user                                            â”‚
â”‚                                                                     â”‚
â”‚  ğŸ”µ LLM Call #4: Format response                                   â”‚
â”‚                                                                     â”‚
â”‚  "âœ“ Started working on **Debugging**."                             â”‚
â”‚                                                                     â”‚
â”‚  Debug Panel shows:                                                â”‚
â”‚  Turn 5 (ğŸ¤– LLM): "Yes" (3100ms)                                   â”‚
â”‚    ğŸ”µ LLM: 3000ms (96%)                                            â”‚
â”‚    ğŸ› ï¸ Tools: 100ms (4%)                                            â”‚
â”‚      - Call 1: start_task (50ms)                                   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

â±ï¸ Total Time (over 2 turns):
   Turn 1: ~3 seconds (search + confirm)
     - LLM: 2850ms
     - MongoDB search: 150ms

   Turn 2: ~3 seconds (execute + confirm)
     - LLM: 3000ms
     - MongoDB update: 50ms
```

---

## Flow 3: "Add a note to debugging task - Fixed memory leak"

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ USER INPUT                                                          â”‚
â”‚ "Add a note to debugging task - Fixed memory leak"                 â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                            â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ STEP 1: Search for task (same as Flow 2)                           â”‚
â”‚                                                                     â”‚
â”‚  ğŸ”µ LLM decides to call: search_tasks                              â”‚
â”‚  ğŸŸ¢ MongoDB hybrid search: ~150ms                                  â”‚
â”‚  ğŸ”µ LLM asks for confirmation                                      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                            â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ STEP 2: User confirms                                              â”‚
â”‚ "Yes"                                                               â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                            â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ STEP 3: Add note                                                   â”‚
â”‚                                                                     â”‚
â”‚  ğŸ”µ LLM Call: Decide action                                        â”‚
â”‚                                                                     â”‚
â”‚  LLM Output:                                                       â”‚
â”‚  {                                                                 â”‚
â”‚    "stop_reason": "tool_use",                                      â”‚
â”‚    "content": [{                                                   â”‚
â”‚      "type": "tool_use",                                           â”‚
â”‚      "name": "add_note_to_task",                                   â”‚
â”‚      "input": {                                                    â”‚
â”‚        "task_id": "abc123",                                        â”‚
â”‚        "note": "Fixed memory leak"                                 â”‚
â”‚      }                                                             â”‚
â”‚    }]                                                              â”‚
â”‚  }                                                                 â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                            â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ STEP 4: Execute note addition                                      â”‚
â”‚                                                                     â”‚
â”‚  coordinator._execute_tool("add_note_to_task", {...})              â”‚
â”‚                                                                     â”‚
â”‚  result = worklog_agent._add_note(                                 â”‚
â”‚    target_type="task",                                             â”‚
â”‚    target_id="abc123",                                             â”‚
â”‚    note="Fixed memory leak"                                        â”‚
â”‚  )                                                                 â”‚
â”‚                                                                     â”‚
â”‚  ğŸ’¾ MongoDB Update (~60ms)                                         â”‚
â”‚  db.tasks.update_one(                                              â”‚
â”‚    {"_id": "abc123"},                                              â”‚
â”‚    {                                                               â”‚
â”‚      "$push": {                                                    â”‚
â”‚        "notes": {                                                  â”‚
â”‚          "text": "Fixed memory leak",                              â”‚
â”‚          "created_at": "2026-01-04T17:45:00Z"                      â”‚
â”‚        }                                                           â”‚
â”‚      }                                                             â”‚
â”‚    }                                                               â”‚
â”‚  )                                                                 â”‚
â”‚                                                                     â”‚
â”‚  Returns: {                                                        â”‚
â”‚    "success": true,                                                â”‚
â”‚    "message": "Note added to task"                                 â”‚
â”‚  }                                                                 â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                            â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ STEP 5: Confirm to user                                            â”‚
â”‚                                                                     â”‚
â”‚  ğŸ”µ LLM Call: Format response                                      â”‚
â”‚                                                                     â”‚
â”‚  "âœ“ Added note to **Debugging**: 'Fixed memory leak'"              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

â±ï¸ Total Time: Same pattern as Flow 2
   - Search + confirm: ~3 seconds
   - Execute + confirm: ~3 seconds
```

---

## Key Architectural Insights

### 1. Single LLM Pattern
```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Coordinator  â”‚ â† ONLY agent with active LLM
â”‚   ğŸ”µ LLM     â”‚    Makes ALL decisions
â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜
       â”‚
       â”œâ”€â”€â†’ Worklog   (has LLM, but NEVER used)
       â””â”€â”€â†’ Retrieval (has LLM, but NEVER used)
```

### 2. Tool Routing Pattern
```
User Query
    â†“
LLM decides which tool
    â†“
Coordinator routes to agent
    â†“
Agent executes DB operation
    â†“
Result back to LLM
    â†“
LLM formats response
```

### 3. Confirmation Pattern (Safety)
```
Action request â†’ Search â†’ Show matches â†’ Ask confirmation â†’ Execute

Example:
"Mark X as done"
    â†“ search_tasks
Found: [Task X]
    â†“ ask user
"Is this the one?"
    â†“ user: "yes"
complete_task(X)
    â†“
"âœ“ Marked X as done"
```

### 4. Latency Breakdown
```
LLM-routed query: 3-5 seconds total
  ğŸ”µ LLM thinking:    80-90% (2-4 seconds)
  ğŸŸ¢ MongoDB:          2-5%  (50-150ms)
  ğŸŸ¡ Embeddings:       5-10% (200-400ms)
  âšª Processing:       <5%   (<50ms)

Slash command: 50-150ms total
  ğŸ’¾ MongoDB only:     100%  (no LLM)
```

### 5. Why Two Turns for Actions?
**Safety by design:**
1. Turn 1: Search and confirm - prevents accidental actions
2. Turn 2: Execute and report - only after explicit user confirmation

This prevents:
- Completing wrong tasks
- Acting on ambiguous references
- Destructive operations without confirmation

---

## Comparison: LLM vs Slash Commands

| Aspect | LLM-Routed | Slash Commands |
|--------|------------|----------------|
| **Speed** | 3-5 seconds | 50-150ms |
| **Flexibility** | Natural language | Exact syntax |
| **Safety** | Confirms before actions | Direct execution |
| **Tools** | Can combine multiple | Single query |
| **Cost** | API tokens | Free |
| **Use Case** | Complex workflows, actions | Quick lookups |

**Example:**
- "Create a high priority task for fixing memory leak in AgentOps" â†’ LLM (understands intent)
- `/tasks status:in_progress project:"AgentOps"` â†’ Slash (direct query)

---

## Evals Dashboard Architecture (Milestone 3)

### System Overview

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                     Evals Dashboard (Port 8502)                  â”‚
â”‚                                                                   â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”          â”‚
â”‚  â”‚ Config       â”‚  â”‚  Summary     â”‚  â”‚  Matrix      â”‚           â”‚
â”‚  â”‚ Selection    â”‚  â”‚  Metrics     â”‚  â”‚  View        â”‚           â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜          â”‚
â”‚         â”‚                                                         â”‚
â”‚         â–¼                                                         â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                                â”‚
â”‚  â”‚  Run Comparison              â”‚                                â”‚
â”‚  â”‚  â€¢ Select 2+ configs         â”‚                                â”‚
â”‚  â”‚  â€¢ Execute 40 test queries   â”‚                                â”‚
â”‚  â”‚  â€¢ Track metrics             â”‚                                â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                                â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                  â–¼
       â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
       â”‚  ComparisonRunner      â”‚
       â”‚  â€¢ Run tests per configâ”‚
       â”‚  â€¢ Collect metrics     â”‚
       â”‚  â€¢ Compute summaries   â”‚
       â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                â”‚
       â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”
       â–¼                 â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Coordinator â”‚   â”‚ SlashCommandExec â”‚
â”‚ (with opts) â”‚   â”‚ (direct DB)      â”‚
â””â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜   â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
      â”‚                  â”‚
      â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜
                 â–¼
      â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
      â”‚  MongoDB Storage â”‚
      â”‚  â€¢ Tasks/Projectsâ”‚
      â”‚  â€¢ Comparison runsâ”‚
      â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### Data Flow

1. **Test Suite Definition** (`evals/test_suite.py`)
   - 40 test queries across 5 sections
   - Input types: SLASH, TEXT, VOICE
   - Dependency tracking for multi-turn tests

2. **Configuration Variants** (`evals/configs.py`)
   - **baseline**: No optimizations
   - **compress_results**: Tool result compression only
   - **streamlined_prompt**: Directive-based prompt only
   - **prompt_caching**: Prompt caching only
   - **all_context**: All optimizations combined

3. **Test Execution** (`evals/runner.py`)
   ```
   For each test in suite:
     For each config:
       1. Apply optimization settings
       2. Execute query (slash or LLM)
       3. Measure latency, tokens, cache hits
       4. Store result

   Compute summaries:
     - Avg latency per config
     - Avg tokens per config
     - Pass rate per config
     - Best config per test
     - Improvement % vs baseline
   ```

4. **Result Storage** (`evals/result.py`)
   ```python
   ConfigResult       # Single test, single config
   â”œâ”€â”€ latency_ms
   â”œâ”€â”€ tokens_in/out
   â”œâ”€â”€ cache_hit
   â””â”€â”€ tools_called

   TestComparison     # Single test, all configs
   â”œâ”€â”€ results_by_config
   â”œâ”€â”€ best_config
   â””â”€â”€ improvement_pct

   ComparisonRun      # All tests, all configs
   â”œâ”€â”€ summary_by_config
   â”œâ”€â”€ tests[]
   â””â”€â”€ run metadata
   ```

5. **Persistence** (`evals/storage.py`)
   - MongoDB collection: `eval_comparison_runs`
   - Save after each run
   - Load history for comparison
   - List past runs in sidebar

### Performance Metrics Tracked

| Metric | Description | Usage |
|--------|-------------|-------|
| **Latency** | Total response time | Primary optimization target |
| **LLM Time** | Time spent in Claude API | Identify LLM bottlenecks |
| **Tool Time** | Time in DB/API calls | Identify tool bottlenecks |
| **Tokens In** | Input tokens to LLM | Context size measurement |
| **Tokens Out** | Output tokens from LLM | Response verbosity |
| **Cache Hit** | Prompt cache utilized | Caching effectiveness |
| **Tools Called** | Which tools executed | Tool usage patterns |
| **Pass Rate** | % successful completions | Reliability tracking |

### Charts and Visualizations

1. **Average Latency** - Bar chart comparing latencies
2. **Average Tokens** - Token usage by config
3. **Accuracy** - Pass rate comparison
4. **Latency Reduction** - % improvement vs baseline
5. **Sequence Over Time** - Line chart showing cache warming

### Example Comparison

```
Test #11: "What are my tasks?"

Baseline Config:
  Latency: 3200ms
  Tokens In: 2150
  Cache Hit: false

All Context Engineering:
  Latency: 1900ms (-40.6%)
  Tokens In: 1420 (-33.9%)
  Cache Hit: true

Improvement: 40.6% faster, 33.9% fewer tokens
```

---

## Context Engineering Optimizations (Milestone 2)

### 1. Tool Result Compression

**Problem**: Tool results contain verbose, repetitive data that inflates context.

**Solution**: Compress results while preserving key information.

```python
# Before (15 tasks Ã— 200 chars = 3000 chars)
[
  {"_id": "abc", "title": "Debug", "status": "todo", "priority": "high", ...},
  {"_id": "def", "title": "Test", "status": "in_progress", ...},
  ...
]

# After (~1000 chars, 67% reduction)
15 tasks. Todo: 8, In Progress: 5, Done: 2
High Priority: 3 tasks (Debug, Deploy, Review)
Recent: Debug (created 2h ago), Test (started 1h ago)
```

**Impact**: 60-70% context reduction, minimal information loss.

### 2. Streamlined System Prompt

**Before**: 850 tokens of detailed instructions and examples
**After**: 420 tokens of directive-based instructions
**Reduction**: 51%

**Key Changes**:
- Remove verbose examples
- Use bullet points instead of prose
- Focus on essential directives
- Rely on Claude's base capabilities

**Impact**: Faster processing, lower cache warming cost.

### 3. Prompt Caching

**Mechanism**: Anthropic's prompt caching feature
- Cache system prompt prefix
- First query: Normal latency + cache write
- Subsequent queries: 40-60% faster

**Implementation**:
```python
messages = [
  {
    "role": "user",
    "content": system_prompt,
    "cache_control": {"type": "ephemeral"}  # Cache this
  },
  ...conversation...
]
```

**Impact**:
- First query: +200ms (cache write)
- Subsequent: -1200ms (cache read)
- Break-even: After 2 queries

---

## Voice Input Flow (Milestone 2)

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ USER                                                        â”‚
â”‚ ğŸ¤ Clicks microphone, speaks: "What tasks are in progress?"â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                         â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ STEP 1: Browser captures audio                             â”‚
â”‚                                                             â”‚
â”‚ navigator.mediaDevices.getUserMedia()                       â”‚
â”‚ Records audio chunks â†’ WAV format                           â”‚
â”‚ Stop recording â†’ Binary audio data                          â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                         â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ STEP 2: Send to Streamlit backend                          â”‚
â”‚                                                             â”‚
â”‚ POST audio bytes to st.session_state                        â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                         â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ STEP 3: OpenAI Whisper transcription                       â”‚
â”‚                                                             â”‚
â”‚ utils/audio.py:                                             â”‚
â”‚   transcribe_audio(audio_bytes)                             â”‚
â”‚   â†’ OpenAI Whisper API call                                 â”‚
â”‚   â†’ Returns: "What tasks are in progress?"                  â”‚
â”‚                                                             â”‚
â”‚ â±ï¸ ~500-800ms                                               â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                         â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ STEP 4: Process as text                                    â”‚
â”‚                                                             â”‚
â”‚ Text flows through normal pipeline:                         â”‚
â”‚ â†’ Check if slash command                                    â”‚
â”‚ â†’ If not, send to coordinator                               â”‚
â”‚ â†’ LLM processes and responds                                â”‚
â”‚                                                             â”‚
â”‚ (Same flow as typing the text)                              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**Key Insight**: Voice is just an input method. After transcription, it's identical to text input.
